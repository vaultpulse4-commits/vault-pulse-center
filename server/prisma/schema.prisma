generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Equipment {
  id              String                @id @default(uuid())
  name            String
  status          EquipmentStatus       @default(Ready)
  lastInspection  DateTime
  nextDue         DateTime
  firmware        String
  city            City
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  description     String                @default("")
  photo           String?
  areaId          String?
  area            Area?                 @relation(fields: [areaId], references: [id])
  inspections     EquipmentInspection[]
  maintenanceLogs MaintenanceLog[]

  @@index([city])
  @@index([status])
  @@index([areaId])
}

model Area {
  id          String      @id @default(uuid())
  name        String      @unique
  description String      @default("")
  isActive    Boolean     @default(true)
  city        City?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  equipment   Equipment[]

  @@index([isActive])
  @@index([city])
}

model EquipmentInspection {
  id          String    @id @default(uuid())
  equipmentId String
  inspector   String
  condition   String
  notes       String
  issues      String[]
  date        DateTime  @default(now())
  createdAt   DateTime  @default(now())
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@index([date])
}

model EventBrief {
  id                   String      @id @default(uuid())
  artist               String
  genre                String      @default("")
  setTimes             String      @default("")
  stagePlotLink        String?
  inputListLink        String?
  monitorNeeds         String      @default("")
  ljCueNotes           String      @default("")
  vjContentChecklist   String      @default("")
  timecodeRouting      String      @default("")
  sfxNotes             String      @default("")
  briefStatus          BriefStatus @default(Draft)
  riskLevel            RiskLevel   @default(Low)
  city                 City
  date                 DateTime
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  audioOrder           String      @default("")
  brandMoment          String      @default("")
  liveSetRecording     String      @default("")
  specialLightingOrder String      @default("")
  visualOrder          String      @default("")

  @@index([city])
  @@index([date])
}

model CrewMember {
  id              String           @id @default(uuid())
  name            String
  role            String
  shift           ShiftType
  assigned        Boolean          @default(false)
  city            City
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  maintenanceLogs MaintenanceLog[]

  @@index([city])
  @@index([shift])
}

model MaintenanceLog {
  id           String            @id @default(uuid())
  type         MaintenanceType
  issue        String
  status       MaintenanceStatus @default(Scheduled)
  mttr         Float?
  cost         Float
  parts        String[]
  date         DateTime
  city         City
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  equipmentId  String?
  notes        String            @default("")
  technicianId String?
  photo        String            @default("")
  supplierId   String?
  equipment    Equipment?        @relation(fields: [equipmentId], references: [id])
  supplier     Supplier?         @relation(fields: [supplierId], references: [id])
  technician   CrewMember?       @relation(fields: [technicianId], references: [id])

  @@index([city])
  @@index([status])
  @@index([equipmentId])
  @@index([technicianId])
  @@index([supplierId])
}

model Incident {
  id          String       @id @default(uuid())
  type        IncidentType
  description String
  rootCause   String
  prevention  String
  impact      String
  date        DateTime
  city        City
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([city])
  @@index([date])
}

model Proposal {
  id                 String          @id @default(uuid())
  title              String
  type               ProposalType
  urgency            ProposalUrgency
  estimate           Float
  vendor             String          @default("")
  status             ProposalStatus  @default(Pending)
  owner              String
  nextAction         String          @default("")
  city               City
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  description        String          @default("")
  quotesCount        Int             @default(0)
  targetDate         DateTime?
  estimateApproved   Boolean         @default(false)
  estimateApprovedBy String?
  quotesPdfs         String[]        @default([])
  proposalPlanFiles  String[]        @default([])
  supplierId         String?
  supplier           Supplier?       @relation(fields: [supplierId], references: [id])

  @@index([city])
  @@index([status])
  @@index([supplierId])
}

model RndProject {
  id             String    @id @default(uuid())
  title          String
  description    String
  phase          RndPhase  @default(Idea)
  progress       Int       @default(0)
  risks          String[]
  dependencies   String[]
  lead           String
  budget         Float
  city           City
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  actualCost     Float     @default(0)
  actualLiveDate DateTime?
  milestones     Json      @default("[]")
  notes          String    @default("")
  status         RndStatus @default(Active)
  targetDate     DateTime?

  @@index([city])
  @@index([phase])
  @@index([status])
}

model Consumable {
  id                 String              @id @default(uuid())
  name               String
  category           String
  currentStock       Float               @default(0)
  reorderPoint       Int                 @default(0)
  unit               String
  city               City
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  description        String?
  image              String?
  location           String?
  maxStock           Int?
  minStock           Int                 @default(0)
  reorderQty         Int                 @default(0)
  unitCost           Float               @default(0)
  supplierId         String?
  supplier           Supplier?           @relation(fields: [supplierId], references: [id])
  purchaseOrderItems PurchaseOrderItem[]
  stockMovements     StockMovement[]

  @@index([city])
  @@index([currentStock])
  @@index([category])
  @@index([supplierId])
}

model Supplier {
  id              String           @id @default(uuid())
  name            String
  code            String           @unique
  contactPerson   String?
  email           String?
  phone           String?
  address         String?
  city            City
  taxId           String?
  paymentTerms    Int              @default(30)
  rating          Float?           @default(0)
  status          SupplierStatus   @default(Active)
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  consumables     Consumable[]
  maintenanceLogs MaintenanceLog[]
  proposals       Proposal[]
  purchaseOrders  PurchaseOrder[]

  @@index([city])
  @@index([status])
  @@index([code])
}

model PurchaseOrder {
  id           String              @id @default(uuid())
  orderNumber  String              @unique
  supplierId   String
  orderDate    DateTime            @default(now())
  expectedDate DateTime?
  receivedDate DateTime?
  status       PurchaseOrderStatus @default(Draft)
  totalAmount  Float               @default(0)
  notes        String?
  city         City
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  supplier     Supplier            @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  items        PurchaseOrderItem[]

  @@index([city])
  @@index([supplierId])
  @@index([status])
  @@index([orderNumber])
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  consumableId    String
  quantity        Float
  receivedQty     Float         @default(0)
  unitPrice       Float
  totalPrice      Float
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  consumable      Consumable    @relation(fields: [consumableId], references: [id], onDelete: Cascade)
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@index([consumableId])
}

model StockMovement {
  id            String            @id @default(uuid())
  consumableId  String
  type          StockMovementType
  quantity      Float
  balanceBefore Float
  balanceAfter  Float
  unitCost      Float?
  totalCost     Float?
  reference     String?
  notes         String?
  performedBy   String?
  city          City
  createdAt     DateTime          @default(now())
  consumable    Consumable        @relation(fields: [consumableId], references: [id], onDelete: Cascade)

  @@index([consumableId])
  @@index([city])
  @@index([type])
  @@index([createdAt])
}

model Alert {
  id           String    @id @default(uuid())
  type         AlertType
  title        String
  message      String
  timestamp    DateTime  @default(now())
  acknowledged Boolean   @default(false)
  city         City
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([city])
  @@index([acknowledged])
}

model KPIMetrics {
  id                        String   @id @default(uuid())
  city                      City     @unique
  nightsOpen                Int
  equipmentUptimePercentage Float
  issuesRaised              Int
  issuesResolved            Int
  powerIncidents            Int
  weekYear                  Int
  weekNumber                Int
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@index([city])
  @@index([weekYear, weekNumber])
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  password          String
  name              String
  role              UserRole           @default(operator)
  cities            City[]
  isActive          Boolean            @default(true)
  lastLogin         DateTime?
  refreshToken      String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  notifications     Notification[]
  pushSubscriptions PushSubscription[]

  @@index([email])
  @@index([role])
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([endpoint])
}

model Notification {
  id        String               @id @default(uuid())
  userId    String
  type      NotificationType
  category  NotificationCategory
  title     String
  message   String
  data      Json?
  city      City?
  read      Boolean              @default(false)
  readAt    DateTime?
  actionUrl String?
  createdAt DateTime             @default(now())
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@index([city])
}

model Permission {
  id              String           @id @default(uuid())
  name            String           @unique
  displayName     String
  description     String?
  category        String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]

  @@index([category])
}

model RolePermission {
  id           String     @id @default(uuid())
  role         UserRole
  permissionId String
  granted      Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
  @@index([permissionId])
}

enum City {
  jakarta
  bali
}

enum ShiftType {
  day
  night
}

enum EquipmentStatus {
  Ready
  Degraded
  OOS
  In_Transit
  Spare
}

enum RiskLevel {
  Low
  Med
  High
}

enum BriefStatus {
  Draft
  Final
}

enum MaintenanceType {
  Preventive
  Corrective
}

enum MaintenanceStatus {
  Completed
  In_Progress
  Scheduled
}

enum IncidentType {
  Audio
  Lighting
  Video
  Power
  Safety
}

enum ProposalType {
  CapEx
  OpEx
}

enum ProposalUrgency {
  High
  Medium
  Low
}

enum ProposalStatus {
  Pending
  Approved
  Rejected
  Completed
}

enum RndPhase {
  Idea
  POC
  Pilot
  Live
}

enum RndStatus {
  Active
  OnHold
  Completed
  Archived
}

enum AlertType {
  critical
  warning
  info
}

enum PurchaseOrderStatus {
  Draft
  Submitted
  Approved
  Ordered
  PartiallyReceived
  Received
  Cancelled
}

enum StockMovementType {
  Purchase
  Usage
  Adjustment
  Return
  Transfer
  Waste
}

enum SupplierStatus {
  Active
  Inactive
  Suspended
}

enum UserRole {
  admin
  manager
  operator
}

enum NotificationType {
  CRITICAL
  WARNING
  INFO
  SUCCESS
}

enum NotificationCategory {
  EQUIPMENT
  MAINTENANCE
  INVENTORY
  EVENT
  SYSTEM
  APPROVAL
}
